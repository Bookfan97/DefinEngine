# This starter workflow is for a CMake project running on multiple platforms. There is a different starter workflow if you just want a single platform.
# See: https://github.com/actions/starter-workflows/blob/main/ci/cmake-single-platform.yml
name: Build and Release

on:
  push:
    branches: [ "main" ]
    
permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: deployment
  cancel-in-progress: true

jobs:
  get-version:
    name: Determine Next Version
    runs-on: ubuntu-latest
    outputs:
      new-version: ${{ steps.semantic.outputs.new_release_version }}
      new-release-published: ${{ steps.semantic.outputs.new_release_published }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Semantic Release (Dry Run)
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Run semantic-release in dry-run mode to get the next version
          # We use npx to run the local version from package.json
          # Allow command to fail (e.g. no changes, authentication issues) without failing the job
          npx semantic-release --dry-run > release_output_raw.txt 2>&1 || true
          
          # Strip ANSI color codes for reliable parsing
          sed 's/\x1b\[[0-9;]*m//g' release_output_raw.txt > release_output.txt
          cat release_output.txt
          
          # Extract version from output if a new release is planned
          VERSION=$(grep -oP 'The next release version is \K[0-9]+\.[0-9]+\.[0-9]+' release_output.txt || echo "")
          
          if [ -n "$VERSION" ]; then
            echo "new_release_version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "new_release_published=true" >> "$GITHUB_OUTPUT"
          else
            echo "new_release_published=false" >> "$GITHUB_OUTPUT"
            echo "No new version detected from semantic-release, checking git tags..."
            
            # Fallback to latest tag
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            
            if [ -n "$LATEST_TAG" ]; then
              # Strip optional v prefix
              CLEAN_TAG=${LATEST_TAG#v}
              echo "Found git tag: $LATEST_TAG, using version: $CLEAN_TAG"
              echo "new_release_version=$CLEAN_TAG" >> "$GITHUB_OUTPUT"
            else
              echo "No tag found. Defaulting to 0.0.1"
              echo "new_release_version=0.0.1" >> "$GITHUB_OUTPUT"
            fi
          fi

  build:
    name: Build (${{ matrix.os }}, ${{ matrix.c_compiler }})
    runs-on: ${{ matrix.os }}
    needs: get-version

    strategy:
      fail-fast: false
      matrix:
        os: [
          ubuntu-latest,
          windows-latest,
          macos-latest
        ]
        build_type: [Release]
        c_compiler: [gcc, clang, cl]
        include:
          - os: windows-latest
            c_compiler: cl
            cpp_compiler: cl
          - os: ubuntu-latest
            c_compiler: gcc
            cpp_compiler: g++
          - os: ubuntu-latest
            c_compiler: clang
            cpp_compiler: clang++
          - os: macos-latest
            c_compiler: clang
            cpp_compiler: clang++
        exclude:
          - os: windows-latest
            c_compiler: gcc
          - os: windows-latest
            c_compiler: clang
          - os: ubuntu-latest
            c_compiler: cl
          - os: macos-latest
            c_compiler: gcc
          - os: macos-latest
            c_compiler: cl

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake pkg-config \
          libx11-dev libxcursor-dev libxinerama-dev libxrandr-dev libxi-dev \
          libxext-dev libxfixes-dev libxrender-dev libxxf86vm-dev \
          libgl-dev libgl1-mesa-dev libglu1-mesa-dev libegl-dev \
          libwayland-dev libwayland-bin wayland-protocols \
          libxkbcommon-dev

    - name: Set reusable strings
      id: strings
      shell: bash
      run: |
        echo "build-output-dir=${{ github.workspace }}/build" >> "$GITHUB_OUTPUT"

    - name: Configure CMake
      run: >
        cmake -B ${{ steps.strings.outputs.build-output-dir }}
        -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }}
        -DCMAKE_C_COMPILER=${{ matrix.c_compiler }}
        -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
        -DCMAKE_PROJECT_VERSION=${{ needs.get-version.outputs.new-version }}
        -S ${{ github.workspace }}

    - name: Build
      run: cmake --build ${{ steps.strings.outputs.build-output-dir }} --config ${{ matrix.build_type }}

    - name: Test
      working-directory: ${{ steps.strings.outputs.build-output-dir }}
      run: ctest --build-config ${{ matrix.build_type }}

    - name: Package
      working-directory: ${{ steps.strings.outputs.build-output-dir }}
      run: cpack -C ${{ matrix.build_type }}

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: package-${{ matrix.os }}-${{ matrix.c_compiler }}
        path: ${{ steps.strings.outputs.build-output-dir }}/GameDevelopmentProject-*.*

  documentation:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Doxygen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz

      - name: Run Doxygen
        run: doxygen Doxyfile

      - name: Convert to Markdown
        run: |
          npm install -g moxygen
          mkdir -p wiki_content
          moxygen -o wiki_content/API.md docs/xml
          if [ ! -f wiki_content/Home.md ]; then
            echo "# Basic Game Engine Documentation" > wiki_content/Home.md
            echo "Welcome to the API documentation for the Basic Game Engine." >> wiki_content/Home.md
            echo "Check out the [API Documentation](API) page." >> wiki_content/Home.md
          fi

      - name: Deploy to Wiki
        uses: Andrew-Chen-Wang/github-wiki-action@v5
        with:
          path: wiki_content
          strategy: clone

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: build
    # Only release on main, and only if build succeeded
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: package-*
          merge-multiple: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release
